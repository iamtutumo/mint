(security_headers) {
    header -Server
    header X-Frame-Options DENY
    header X-Content-Type-Options nosniff
    header X-XSS-Protection "1; mode=block"
    header Referrer-Policy "strict-origin-when-cross-origin"
}

# Local development configuration
:80 {
    encode zstd gzip
    
    # Frontend routes
    # Realtime Transcriber on root path /transcriber or /realtime-transcriber
    handle /transcriber* {
        reverse_proxy realtime-transcriber:3000 {
            header_uri -Host
            header_uri Host realtime-transcriber:3000
        }
    }
    
    # Voice Agent on /voice-agent path
    handle /voice-agent* {
        reverse_proxy voice-agent:3000 {
            header_uri -Host
            header_uri Host voice-agent:3000
        }
    }
    
    # PWA on /pwa path (or as fallback)
    handle /pwa* {
        reverse_proxy pwa:80 {
            header_uri -Host
            header_uri Host pwa:80
        }
    }
    
    # API routes to gateway
    handle /api/* {
        reverse_proxy gateway:8080 {
            header_uri -Host
            header_uri Host gateway:8080
        }
    }
    
    # WebSocket routes
    handle /ws/* {
        reverse_proxy gateway:8080 {
            header_uri -Host
            header_uri Host gateway:8080
        }
    }
    
    # Serve Realtime Transcriber as default (root)
    handle /* {
        reverse_proxy realtime-transcriber:3000 {
            header_uri -Host
            header_uri Host realtime-transcriber:3000
        }
    }
    
    # Security headers
    import security_headers
}

# HTTPS configuration for production (when configured)
:443 {
    encode zstd gzip
    
    # Same routes as above for HTTPS
    handle /transcriber* {
        reverse_proxy realtime-transcriber:3000
    }
    
    handle /voice-agent* {
        reverse_proxy voice-agent:3000
    }
    
    handle /pwa* {
        reverse_proxy pwa:80
    }
    
    handle /api/* {
        reverse_proxy gateway:8080
    }
    
    handle /ws/* {
        reverse_proxy gateway:8080
    }
    
    handle /* {
        reverse_proxy realtime-transcriber:3000
    }
    
    import security_headers
    
    # TLS configuration (auto or manual)
    tls internal
}
